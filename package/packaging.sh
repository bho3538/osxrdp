#!/bin/bash

# generated by AI

# ==========================================
# ì„¤ì • ë³€ìˆ˜
# ==========================================
APP_NAME="OSXRDP.app"
UNINS_APP_NAME="OSXRDPUninstaller.app"
INSTALL_FOLDER_NAME="osxrdp"
PKG_ID="com.byungho.osxrdp.setup"
VERSION="1.4.0"

# íŒŒì¼ëª… ì„¤ì •
COMPONENT_PKG="osxrdp_component.pkg"
OUTPUT_PKG="osxrdp_installer_v${VERSION}.pkg"
DIST_XML="distribution.xml"

# ê²½ë¡œ ì„¤ì •
ROOT_DIR=$(pwd)
PAYLOAD_DIR="$ROOT_DIR/payload"
SOURCE_DIR="$ROOT_DIR/source"
SCRIPTS_DIR="$ROOT_DIR/scripts"

# [ì¶”ê°€ë¨] ì„œëª… ë° ê³µì¦ ì„¤ì •
# í„°ë¯¸ë„ì—ì„œ 'security find-identity -v -p installer' ë¡œ í™•ì¸í•œ ì´ë¦„ ("Developer ID Installer: Name (TeamID)")
SIGNING_IDENTITY="Developer ID Installer: BYEONGHO KIM (33X7M69J4B)"

# í„°ë¯¸ë„ì—ì„œ 'xcrun notarytool store-credentials' ëª…ë ¹ì–´ë¡œ ìƒì„±í•œ í”„ë¡œí•„ ì´ë¦„
NOTARY_KEYCHAIN_PROFILE="AC_PASSWORD"

# ==========================================
# 0. ì‚¬ì „ ì²´í¬
# ==========================================
if [ ! -f "$DIST_XML" ]; then
    echo "âŒ Error: $DIST_XML not found in current directory."
    exit 1
fi

echo "=== [1/6] Cleaning up old build files ==="
rm -rf "$PAYLOAD_DIR"
rm -f "$COMPONENT_PKG" "$OUTPUT_PKG"

# ==========================================
# 1. Payload êµ¬ì„±
# ==========================================
echo "=== [2/6] Staging files into Payload ==="

mkdir -p "$PAYLOAD_DIR/Applications/$INSTALL_FOLDER_NAME"
mkdir -p "$PAYLOAD_DIR/Library/LaunchDaemons"
mkdir -p "$PAYLOAD_DIR/etc/xrdp"
mkdir -p "$PAYLOAD_DIR/usr/local/lib/xrdp"
mkdir -p "$PAYLOAD_DIR/usr/local/share/xrdp"

# ì•± ë³µì‚¬ (ì´ë¯¸ ì„œëª…ëœ ì•±ì´ë¼ê³  ê°€ì •)
if [ -d "$SOURCE_DIR/$APP_NAME" ]; then
    cp -R "$SOURCE_DIR/$APP_NAME" "$PAYLOAD_DIR/Applications/$INSTALL_FOLDER_NAME/"
else
    echo "âŒ Error: '$APP_NAME' not found in source directory."
    exit 1
fi

if [ -d "$SOURCE_DIR/$UNINS_APP_NAME" ]; then
    cp -R "$SOURCE_DIR/$UNINS_APP_NAME" "$PAYLOAD_DIR/Applications/$INSTALL_FOLDER_NAME/"
else
    echo "âŒ Error: '$UNINS_APP_NAME' not found in source directory."
    exit 1
fi
# ê¸°íƒ€ íŒŒì¼ ë³µì‚¬
cp "$SOURCE_DIR/com.byungho.osxrdp.plist" "$PAYLOAD_DIR/Library/LaunchDaemons/"
if [ -d "$SOURCE_DIR/config" ]; then
    cp -R "$SOURCE_DIR/config/"* "$PAYLOAD_DIR/etc/xrdp/"
fi
cp "$SOURCE_DIR/module/libosxup.dylib" "$PAYLOAD_DIR/usr/local/lib/xrdp"
cp "$SOURCE_DIR/resources/"* "$PAYLOAD_DIR/usr/local/share/xrdp"

# ê¶Œí•œ ì„¤ì •
echo "=== [3/6] Setting permissions ==="
sudo chown -R root:wheel "$PAYLOAD_DIR"
sudo chmod 755 "$PAYLOAD_DIR/Applications/$INSTALL_FOLDER_NAME"
sudo chmod 755 "$PAYLOAD_DIR/usr/local/lib/xrdp"
sudo chmod 755 "$PAYLOAD_DIR/usr/local/share/xrdp"
sudo chmod 755 "$SCRIPTS_DIR/postinstall"

# ==========================================
# 2. ì»´í¬ë„ŒíŠ¸ íŒ¨í‚¤ì§€ ë¹Œë“œ (pkgbuild)
# ==========================================
echo "=== [4/6] Building Component Package ==="

pkgbuild --root "$PAYLOAD_DIR" \
         --install-location "/" \
         --scripts "$SCRIPTS_DIR" \
         --identifier "$PKG_ID" \
         --version "$VERSION" \
         "$COMPONENT_PKG"

# ==========================================
# 3. ìµœì¢… Product íŒ¨í‚¤ì§€ ë¹Œë“œ ë° ì„œëª… (productbuild)
# ==========================================
echo "=== [5/6] Building & Signing Product Package ==="

# --sign ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œì™€ ë™ì‹œì— ì„œëª…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
productbuild --distribution "$DIST_XML" \
             --package-path . \
             --sign "$SIGNING_IDENTITY" \
             "$OUTPUT_PKG"

if [ $? -ne 0 ]; then
    echo "âŒ Error: Product build or signing failed."
    exit 1
fi

# ==========================================
# 4. ê³µì¦ (Notarization) ë° Stapling
# ==========================================
echo "=== [6/6] Notarizing Package ==="

echo "ğŸ“¤ Uploading to Apple Notary Service... (This may take a while)"
xcrun notarytool submit "$OUTPUT_PKG" \
                 --keychain-profile "$NOTARY_KEYCHAIN_PROFILE" \
                 --wait

if [ $? -eq 0 ]; then
    echo "âœ… Notarization Succeeded!"
    
    echo "ğŸ“ Stapling the ticket to the package..."
    xcrun stapler staple "$OUTPUT_PKG"
    
    echo "ğŸ‰ All Done! Final Package: $OUTPUT_PKG"
else
    echo "âŒ Notarization Failed. Check the log above."
    exit 1
fi

# ì„ì‹œ íŒŒì¼ ì •ë¦¬
rm -f "$COMPONENT_PKG"
sudo rm -rf "$PAYLOAD_DIR"
